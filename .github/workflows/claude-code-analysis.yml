name: Claude Code Analysis

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm ci

    - name: Analyze with Claude
      uses: actions/github-script@v7
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Read key files
          const serverJs = fs.readFileSync('server.js', 'utf8');
          const indexHtml = fs.readFileSync('public/index.html', 'utf8').slice(0, 5000);
          const packageJson = fs.readFileSync('package.json', 'utf8');

          // Call Claude API for analysis
          const fetch = require('node-fetch');
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 8192,
              messages: [{
                role: 'user',
                content: `Analyze this Radio Calico streaming player codebase:

**server.js:**
\`\`\`javascript
${serverJs}
\`\`\`

**package.json:**
\`\`\`json
${packageJson}
\`\`\`

**public/index.html (excerpt):**
\`\`\`html
${indexHtml}
\`\`\`

Provide:
1. Architecture overview and assessment
2. Security vulnerabilities or concerns
3. Performance optimization opportunities
4. Code quality improvements
5. Missing features or enhancements
6. Technical debt identification

Create a prioritized list of actionable improvements.`
              }]
            })
          });

          const analysis = await response.json();
          const analysisText = analysis.content[0].text;

          // Create or update analysis issue
          const title = 'ðŸ¤– Claude Code Analysis Report';
          const body = `# Claude Code Analysis\n\n*Generated: ${new Date().toISOString()}*\n\n${analysisText}\n\n---\n*Powered by Claude 3.5 Sonnet*\n*This analysis is automatically updated on pushes to main.*`;

          // Check if analysis issue already exists
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'claude-analysis'
          });

          if (issues.length > 0) {
            // Update existing issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issues[0].number,
              body: body
            });
            console.log(`Updated issue #${issues[0].number}`);
          } else {
            // Create new issue
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['claude-analysis', 'automated']
            });
            console.log(`Created issue #${issue.number}`);
          }

    - name: Analysis Complete
      run: |
        echo "âœ… Claude code analysis completed"
        echo "ðŸ“Š Analysis report created/updated as GitHub issue"
