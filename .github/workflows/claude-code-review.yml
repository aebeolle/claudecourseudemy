name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          **/*.js
          **/*.html
          **/*.css
          **/*.md

    - name: Claude Code Review
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      with:
        script: |
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');

          // Get file contents and diffs
          const fileDiffs = [];
          for (const file of changedFiles) {
            const { data: diff } = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: context.payload.pull_request.base.sha,
              head: context.payload.pull_request.head.sha,
            });
            fileDiffs.push({ file, diff: diff.files.find(f => f.filename === file)?.patch || '' });
          }

          // Call Claude API for code review
          const fetch = require('node-fetch');
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-3-5-sonnet-20241022',
              max_tokens: 4096,
              messages: [{
                role: 'user',
                content: `Review this code change for a Radio Calico streaming player project.

Files changed: ${changedFiles.join(', ')}

Diffs:
${fileDiffs.map(f => `\n### ${f.file}\n\`\`\`diff\n${f.diff}\n\`\`\``).join('\n')}

Please provide:
1. Code quality assessment
2. Potential bugs or issues
3. Security concerns
4. Performance considerations
5. Best practice recommendations

Focus on actionable feedback.`
              }]
            })
          });

          const review = await response.json();
          const reviewText = review.content[0].text;

          // Post review as PR comment
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.payload.pull_request.number,
            body: `## ü§ñ Claude Code Review\n\n${reviewText}\n\n---\n*Powered by Claude 3.5 Sonnet*`
          });

    - name: Review Summary
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "‚úÖ Claude code review completed"
        echo "üìù Review posted to PR #${{ github.event.pull_request.number }}"
